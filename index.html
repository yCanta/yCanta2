<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="Description" content="yCanta: Offline-first web application for creating and presenting songs and songbooks">
    <meta name="theme-color" content="lightblue">
    <meta name="msapplication-TileColor" content="#00aba9">

    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#ff0000">

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="jquery.myTransposer.css">
    <link rel="stylesheet" type="text/css" href="2html.css">
    <link rel="stylesheet" type="text/css" href="notyf.min.css">
    <title>yCanta2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="An intuitive offline-first progressive web app song manager featuring type-to-search presentation mode and PDF songbook export.">
    <!--script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101248473);</script>
    <script async src="//static.getclicky.com/js"></script-->

  </head>
  <body class="header login">
    <fieldset class="loggedin_display closed align-right" style="position: absolute; top:1.5rem;right:1rem; z-index:7; margin-right: 0;">
      <legend onclick="this.parentElement.classList.toggle('closed');" style="margin-right: 0; padding: 0 .4rem; margin-left: auto;" id="username_legend"><span id="username_d"></span></legend>
      <div class="content">
        <a href="#" style="background-color: var(--background-color);" class="btn" onclick="$(this).closest('fieldset').addClass('closed'); goToSettings();">Settings</a>
        <button style="background-color: var(--background-color);" class="btn" onclick="dbLogout();">Logout</button>
      </div>
    </fieldset>
    <header id="header">
      <div>
        <h2 id="title"><a href="#">yCanta</a></h2>
        <hr>
      </div>
      <div id="lower" style="overflow: hidden; height: calc(100vh - 90px);">
        <div id="login">
          <h2>Login:</h2>
          <select id="db_select">
            <option value="new">Create local</option>
          </select><button class="btn btn-small" onclick="if(confirm('Are you sure you want to delete: '+$('#db_select').val()+'?')){new PouchDB($('#db_select').val()).destroy().then(function () {  console.log('database deleted'); setTimeout(function(){location.reload();},1000); }).catch(function (err) { alert('could not delete database', err)});}">üóë</button>
          <button class="btn" onclick="if(confirm('are you sure you want to delete all data?')){clearAllDbs();};">Clear all</button>
          <input id="newDbUrl" class="d_none" placeholder="DB Url" type="text"></input>
          <input id="newDbName" class="d_none create_local" placeholder="DB Name" type="text"></input>
          <input id="username" placeholder="Username" type="text"></input>
          <input id="pwd" class="d_none" placeholder="Password" type="password"></input>
          <div class="pin d_none create_local login_local">
            <input id="pin" placeholder="Pin" type="password"></input>
            <input id="pin2" class="d_none create_local" placeholder="Renter Pin" type="password"></input>
            <span class="d_none">‚ö†Ô∏è Offline - enter pin</span><br>
          </div>
          <div style="text-align: right;">
            <button class="btn d_none login_local" onclick="if(checkLogin()){dbLogin();}">Login</button>
            <button class="btn d_none create_local" onclick="checkCreateNew();">Create Local</button>
          </div>
        </div>
        <div id="logged_in">
          <div id="welcome">
            <a class="btn songbookList-color" href="#songbooks">Songbooks</a>
            <a class="btn songList-color" href="#sb-allSongs">All Songs</a>

            <h2>Brief Introduction</h2>

            You can view songbooks or songs by selecting one of the above buttons.<br><br>
            <fieldset class="updatedSongs closed-mobile">
              <legend onclick="(this.parentElement.classList.contains('closed-mobile') && (window.innerWidth < 640) ? this.parentElement.classList.remove('closed-mobile') : this.parentElement.classList.toggle('closed'));">Recently Updated Songs</legend>
              <div class="content">
                <ul class="list"></ul>
              </div>
            </fieldset>
          </div>
          <div id="settings">
            <fieldset id="userProfile" class="align-right">
              <legend onclick="this.parentElement.classList.toggle('closed');">User Profile</legend>
              <div class="content">
                <div id="user_content"></div>
              </div>
            </fieldset>
            <fieldset class="closed align-right">
              <legend onclick="this.parentElement.classList.toggle('closed'); loadCategories();">Categories</legend>
              <div class="content">
                <div id="category_content"></div>
              </div>
            </fieldset>
            <fieldset class="closed align-right" id="appSettings">
              <legend onclick="this.parentElement.classList.toggle('closed');">Settings</legend>
              <div class="content">
                <b>Darkmode</b><br><br>
                <div id="darkmode">
                  <input type="radio" name="darkmode" id="darkRadio" value="dark" onchange="handleDarkMode(); logData('darkMode', this.value);">
                  <label for="darkRadio">Dark</label>
                  <input type="radio" name="darkmode" id="autoRadio" value="auto" onchange="handleDarkMode(); logData('darkMode', this.value);">
                  <label for="autoRadio">System</label>
                  <input type="radio" name="darkmode" id="lightRadio" value="light" onchange="handleDarkMode(); logData('darkMode', this.value);">
                  <label for="lightRadio">Light</label>
                </div><br>
              </div>
              <div class="content">
                <label>
                  <b>Font Size:</b> <output id="fontSizeOutput">16px</output><br><br>
                  <input type="range" min="12" max="20" value="16" id="fontSize" name="fontSize" list="tickmarks" onchange="document.getElementById('fontSizeOutput').value=this.value+'px'; document.documentElement.style.fontSize = this.value+'px'; localStorage.setItem(window.user._id+'fontSize', this.value); logData('fontSize', this.value);" style="width:100%; display: block;">
                  <datalist id="tickmarks">
                    <option value="12" label="12px"></option>
                    <option value="16" label="16px"></option>
                    <option value="20" label="20px"></option>
                  </datalist>
                </label>
              </div>
              <div class="content">
                <b>Send Analytics</b><br><br>
                <label class="switch switch-wide">
                  <input type="checkbox" id="analytics" name="analytics" checked onclick="logData('analytics', this.checked); localStorage.setItem(window.user._id+'analytics', this.checked); logData('analytics', this.checked);">
                  <div class="slider" data-text=" "></div>
                </label>
              </div>
              <div class="content">
                <b>Import</b>
                <div>Choose a zip of V1 songs or a json file of V2 and upload it below.</div>
                <span style="margin: 1rem;"><input type="file" id="file" name="file" accept=".json,.zip" style="max-width: 200px; background: var(--edit-color);"/><button class="btn" onclick="startHandlingFiles();">Upload</button></span>
                <div id="result">
                </div>
              </div>
              <div class="content">
                <b>Admin</b><br>
                <a href="#" class="btn" style="background-color: crimson; color: white;" onclick="if(confirm('Are you sure you want to delete this database?')){ db.destroy().then(function () {
                  dbLogout();
                }).catch(function (err) {
                  console.log(err);
              });}">Delete DB</a>
              </div>
            </fieldset>
          </div>
        </div>
      </div>

    </header>
    <main>
      <div class="column active" id="songbookList">
        <div class="float-menu">
          <div>
            <a data-songbook-edit="new" class="float-menu-item"><span class="float-menu-icon">+</span> Add SB</a>
            <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
          </div>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div id="songbooks">
              <div id="songbooks_header" class="column_header">
                <h3><a class="title_link" href="#songbooks">Songbooks</a></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbooks" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list"></ul>
            </div>
            <ul style="display:none">
              <li id="songbook-item-template" 
                  data-songbook-id=""
                  data-songbook-rev=""
                  data-songbook-title=""
                  data-user-fav="">
                <a href="" tabindex="0" class="link name" ></a><span></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="column" id="songList">
        <div class="float-menu">
          <a data-song-edit="new" class="float-menu-item"><span class="float-menu-icon">+</span> Add Song</a>
          <button data-home onclick="deleteSongbook(window.songbook._id)" class="float-menu-item delete"><span class="float-menu-icon">&#128465;</span> Delete</button>
          <button data-songbook-present class="float-menu-item" id="present"><span class="float-menu-icon">&#128253;</span> Present</button>
          <a data-songbook-export class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</a>
          <a data-songbook-edit class="float-menu-item"><span class="float-menu-icon">&#9998;</span> Edit</a>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div id="songbook_content">
              <div id="songbook_header" class="column_header">
                <h3><a data-songbook class="title_link" href="#" id="songbook_title">All Songs</a></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbook_content" data-trigger="change" placeholder="Search">
                <nav id="category_filter_container">
                  <button class="cat_filter_btn" onclick="$('#category_filter_container').toggleClass('open'); $('#songbook_header').toggleClass('mb23');">‚ëÇ</button>
                  <div id="category_filter">
                    <label>Category: 
                      <select onchange="$('#songbook_content .search').val($(this).val())[0].dispatchEvent(new KeyboardEvent('keyup'));">
                      </select>
                    </label>
                  </div>
                </nav>

              </div>
              <ul class="list"></ul>
            </div>
            <ul style="display:none">
              <li id="song-item-template" 
                  data-song-id=""
                  data-song-rev=""
                  data-song-search=""
                  data-song-status=""
                  data-song-deleted="">
                  <a href="" class="link name" tabindex="0"></a>
              </li>
            </ul>
          </div>
          <div class="subcolumn sidebar" id="songListEdit">
            <div id="songbook_edit_togglesongs">
              <div class="column_header">
                <h3>Add a song?<button onclick="$(this).closest('.sidebar-open').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbook_edit_togglesongs" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list">
              </ul>
              <ul style="display:none">
                <li id="song-item-template-edit" 
                  data-song-id=""
                  data-song-rev=""
                  data-song-search=""
                  data-song-status=""
                  data-song-deleted="">
                  <a href="" class="name" tabindex="0" ></a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="column nochords" id="song">
        <div class="float-menu">
          <button data-songbook onclick="deleteSong(window.song._id)" class="float-menu-item"><span class="float-menu-icon">&#128465;</span> Delete</button>
          <a data-song-export class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</a>
          <a data-song-edit class="float-menu-item"><span class="float-menu-icon">&#9998;</span> Edit</a>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div>
              <article class="content">
              </article>
            </div>
          </div>
          <div class="subcolumn sidebar" id="song-edit">
            <div id="categories">
              <div class="column_header">
                <h3>Song Categories<button onclick="$(this).closest('#song-edit').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#categories" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list">
              </ul>
              <ul style="display:none">
                <li id="category-template">
                  <label>
                    <input type="checkbox">
                    <span class="name"></span>
                  </label>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="column" id="export">
        <div class="float-menu">
          <button class="float-menu-item" onclick="window.location.hash=window.location.hash.replace('&export','');"><span class="float-menu-icon">&#128465;</span> Cancel</button>
          <button data-song class="float-menu-item"><span class="float-menu-icon">&#128190;</span> Save</button>
          <span class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</span>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div class="content">
              <div class="column_header">
                <h3 class="export_header">Export</h3>
              </div>
              <table>
                <tr>
                  <td>
                    <button style="background-color: var(--edit-color);" class="btn" onclick="download(JSON.stringify(window.exportObject),window.exportObject.title+'.json','application/json')">SaveV2</button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <button style="background-color: var(--edit-color);" class="btn" onclick="pdfFormatter.postMessage([window.exportObject,read_config_form()]);">GeneratePDF</button>
                    <small style="margin-left: 1rem;"><input id="auto_refresh" name="auto_refresh" type="checkbox"><label for="auto_refresh"> Auto refresh?</label></small>
                  </td>
                  <td style="width: 100%">
                    <div id='pdf_progress_bar' style='border: 1px solid black; position: relative;'>
                      <div style='border-right: 1px solid gray; background-color: var(--edit-color); width:0%; height:1.2em; text-align: center; transition: all 0s;' id='pdf_progress'>
                      </div>
                      <span id='pdf_progress_text' style='font-size:small; white-space:nowrap; position: absolute; top:0; right: 0; left: 0; bottom: 0; text-align: center;'></span>
                    </div>
                  </td>
                </tr>
              </table>
              <br>
              <label for="format">Format</label>
              <select style="width: 100%; background-color: var(--song-color); margin: .5em 0 1em 0" class="lbl-toggle" id="format" name="format">
              </select>
              <form id="export_form">
                <input id="collapsible1" class="toggle" type="radio">
                <label for="collapsible1" class="lbl-toggle">Text Options
                  <span style="display: inline-block;">
                    <span>
                      <div id="font_summary"></div>
                      <div id="text_summary"></div>
                    </span>
                    <span style="border-left: 1px solid white; padding-left: 0.5em;">
                      <div id="song_title_summary"></div>
                      <div id="ccli_summary"></div>
                    </span>
                    <span style="border-left: 1px solid white; padding-left: 0.5em;">
                      <div id="print_summary"></div>
                      <div id="chords_summary"></div>
                    </span>
                  </span>
                </label>
                <div class="collapsible-content">
                  <div class="content-inner">
                    <div class="t3 hide_for_songs export_status" rel="tooltip" title="Choose the songs you want to print based on status">
                      <label>Print</label>
                      <span>
                        <label class="switch">
                          <input type="checkbox" id="print_a" name="print_a">
                          <div class="slider" data-text="‚úì"></div>
                        </label>
                        <label class="switch">
                          <input type="checkbox" id="print_n" name="print_n">
                          <div class="slider" data-text="~"></div>
                        </label>
                        <label class="switch">
                          <input type="checkbox" id="print_r" name="print_r">
                          <div class="slider" data-text="‚úó"></div>
                        </label>
                      </span>
                    </div>
                    <div class="t3">
                      <label for="font_face"  rel="tooltip" title="Font to be used in the songbook">Default Font</label>
                      <select size="1" id="font_face" name="font_face" style="display: inline-block;">
                        <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica" selected>Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label for="display_chords">Display Chords?</label>
                      <select size="1" id="display_chords" name="display_chords">
                        <option value="no">no</option>
                        <option value="yes">yes</option>
                        <option value="yes">1st</option>
                      </select>
                    </div>
                    <div class="t3 hide_for_songs">
                      <label>Start songs on new pages:</label>
                      <label class="switch">
                        <input type="checkbox" id="start_song_on_new_page" name="start_song_on_new_page">
                        <div class="slider"></div>
                      </label>
                    </div>
                    <div class="t3 hide_for_songs">
                      <label for="hide_booktitle">Hide book title?</label>
                      <select size="1" id="hide_booktitle" name="hide_booktitle">
                        <option value="no">no</option><option value="yes">yes</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label for="songtitle_format" rel="tooltip" title="${num} substitutes the song number">Song title # format:</label>
                      <input size="10" type="text" id="songtitle_format" value="${num} " name="songtitle_format">
                    </div>
                    <div class="t3">
                      <label for="scripture_location">Scripture reference:</label>
                      <select size="1" id="scripture_location" name="scripture_location" style="display: inline-block;">
                        <option value="in-title">in-title</option>
                        <option value="under-title">under-title</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label for="ccli">CCLI license#: </label>
                      <input size="7" type="text" id="ccli" name="ccli">
                    </div>
                        
                    <h4>Text Details<select id="text" class="fr">
                      <option value='default'>Default</option>
                      <option value='small'>Small</option>
                      <option value='large'>Large</option>
                      <option value='custom'>Custom</option>
                    </select></h4>
                    <table id="text_table" class="table">
                      <tr>
                        <th></th>
                        <th><small>Size</small></th>
                        <th rel="tooltip" title="Space below the text"><small>Space</small></th>
                        <th rel="tooltip" title="Allow automatic reduction of font size to this percentage of the set font size"><small>Resize</small></th>
                      </tr>
                      <tr class="hide_for_songs">
                        <td>Book Title</td>
                        <td><input type="number" id="booktitle_size" name="booktitle_size" value="24"></td>
                        <td><input type="number" id="booktitle_space" name="booktitle_space" value="12"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>Song Title</td>
                        <td><input type="number" id="songtitle_size" name="songtitle_size" value="14"></td>
                        <td><input type="number" id="songtitle_space" name="songtitle_space" value="6"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td><small>Small Text</small></td>
                        <td><input type="number" id="small_size" name="small_size" value="8"></td>
                        <td><input type="number" id="small_space" name="small_space" value="8"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>Line</td>
                        <td><input type="number" id="songline_size" name="songline_size" value="12"></td>
                        <td><input type="number" id="songline_space" name="songline_space" value="4"></td>
                        <td rel="tooltip" title="Allow automatic reduction of font size to this percentage of the set font size">
                          <select size="1" id="resize_percent" name="resize_percent">
                            <option value="100">100%</option><option value="95">95%</option><option value="90">90%</option><option value="85">85%</option><option value="80">80%</option><option value="75">75%</option><option value="70">70%</option><option value="65">65%</option><option value="60">60%</option><option value="55">55%</option><option value="50">50%</option>
                            <option value="0">Wrap</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td>Chord</td>
                        <td><input type="number" id="songchord_size" name="songchord_size" value="12"></td>
                        <td><input type="number" id="songchord_space" name="songchord_space" value="1"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td colspan=2 rel="tooltip" title="Spacing before Chorus/Verse/Bridge/etc">Block Spacing</td>
                        <td><input type="number" id="songchunk_b4" name="songchunk_b4" value="12"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td colspan=2 rel="tooltip" title="Spacing after the end of the song">Song Spacing</td>
                        <td><input type="number" id="song_space_after" name="song_space_after" value="12"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>Copyright</td>
                        <td><input type="number" id="copyright_size" name="copyright_size" value="8"></td>
                        <td><input type="number" id="copyright_space_b4" name="copyright_space_b4" value="3"></td>
                        <td></td>
                      </tr>
                    </table>
                  </div>
                </div>

                <input id="collapsible2" class="toggle" type="radio">
                <label for="collapsible2" class="lbl-toggle">Page Options
                  <span style="display: inline-block;">
                    <span id="page_icon"></span>
                    <span>
                      <div id="page_size_summary"></div>
                      <div id="margin_gutter"></div>
                    </span>
                    <span id="margin_icon" class="normal">
                      <span class="flex">
                        <span class="col"></span>
                        <span class="col"></span>
                        <span class="col"></span>
                      </span>
                      <span class="flex">
                        <span class="col"></span>
                        <span class="col"></span>
                        <span class="col"></span>
                      </span>
                      <span class="flex">
                        <span class="col"></span>
                        <span class="col"></span>
                        <span class="col"></span>
                      </span>                                        
                    </span>
                    <span>
                      <div id="margin_summary">Normal</div>
                      <div id="margin_summary_nums">1"</div>
                    </span>
                  </span>
                </label>
                <div class="collapsible-content">
                  <div class="content-inner">
                    <div class="t3">
                      <label for="columns" rel="tooltip" title="Number of columns">Columns</label>
                      <span>
                        <input type="number" id="columns" name="columns" value="1">
                      </span>
                    </div>
                    <div class="t3">
                      <label for="page_layout" rel="tooltip" title="Choose the physical layout of the songbook">Layout</label>
                      <select size="1" id="page_layout" name="page_layout">
                        <option value="single-sided">single-sided</option><option value="booklet">booklet</option><option value="double-sided">double-sided</option><option value="adobe-booklet">adobe-booklet</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label for="paper_orientation">Orientation</label>
                      <select size="1" id="paper_orientation" name="paper_orientation">
                        <option value="portrait">portrait</option><option value="landscape">landscape</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label for="paper_size">Paper Size</label>
                      <select size="1" id="paper_size" name="paper_size" style="display: inline-block;">
                        <option value="A0">A0</option><option value="A1">A1</option><option value="A2">A2</option><option value="A3">A3</option><option value="A4">A4</option><option value="A5">A5</option><option value="A6">A6</option><option value="B0">B0</option><option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option><option value="B4">B4</option><option value="B5">B5</option><option value="B6">B6</option><option value="TABLOID">11x17</option><option value="LEGAL">LEGAL</option><option value="LETTER" selected>LETTER</option>
                      </select>
                    </div>
                    <h4>Margins<select id="margin" class="fr">
                      <option value='normal'>Normal</option>
                      <option value='narrow'>Narrow</option>
                      <option value='wide'>Wide</option>
                      <option value='custom'>Custom</option>
                    </select></h4>
                    <table id="margin_table" class="table">
                      <thead>
                        <tr>
                          <th>
                          </th>
                          <th>
                            <small>Size</small>
                          </th>
                          <th>
                          </th>
                          <th>
                            <small>Size</small>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>
                            Top
                          </td>
                          <td>
                            <input type="number" id="paper_margin_top" name="paper_margin_top" value="1" step="0.1" min="0">
                          </td>
                          <td>
                            Bottom
                          </td>
                          <td>
                            <input type="number" id="paper_margin_bottom" name="paper_margin_bottom" value="1" step="0.1" min="0">
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <span data-booklet="Inside">Left</span>
                          </td>
                          <td>
                            <input type="number" id="paper_margin_left" name="paper_margin_left" value="1" step="0.1" min="0">
                          </td>
                          <td>
                            <span data-booklet="Outside">Right</span>
                          </td>
                          <td>
                            <input type="number" id="paper_margin_right" name="paper_margin_right" value="1" step="0.1" min="0">
                          </td>
                        </tr>
                        <tr>
                          <td>
                            Gutter
                          </td>
                          <td>
                            <input type="number" id="paper_margin_gutter" name="paper_margin_gutter" value="0" step="0.1" min="0">
                          </td>
                          <td>
                            Column Gutter
                          </td>
                          <td>
                            <input type="number" id="column_gutter" name="column_gutter" value="1" step="0.1" min="0">
                            <select size="1" id="gutter_side" name="gutter_side">
                              <option value="left">Left</option>
                              <option value="top">Top</option>
                              <option value="inside">Inside</option>
                            </select>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <input id="collapsible3" class="toggle hide_for_songs" type="radio">
                <label for="collapsible3" class="lbl-toggle hide_for_songs">Index Options
                  <span style="display: inline-block;">
                    <span>
                      <div id="alphabetical_summary"></div>
                      <div id="category_summary"></div>
                    </span>
                    <span style="border-left: 1px solid white; padding-left: 0.5em;">
                      <div id="scripture_summary"></div>
                      <div id="index_summary"></div>
                    </span>
                  </span>
                </label>
                <div class="collapsible-content hide_for_songs">
                  <div class="content-inner">
                    <h4>Print Indexes:</h4>
                    <div class="t3">
                      <label for="display_index">Index</label>
                      <select size="1" id="display_index" name="display_index">
                        <option value="on-new-page">On, new page</option>
                        <option value="no-page-break">On, inline</option>
                        <option value="no-index">Off</option>
                      </select>
                      <span style="text-align: right; width: 100%;">
                        <span>Include 1st verse and chorus?</span>
                        <label class="switch">
                          <input type="checkbox" id="include_first_line" name="include_first_line">
                          <div class="slider"></div>
                        </label>
                      </span>
                    </div>
                    <div class="t3">
                      <label for="display_cat_index">Categories</label>
                      <select size="1" id="display_cat_index" name="display_cat_index">
                        <option value="on-new-page">On, new page</option>
                        <option value="no-page-break">On, inline</option>
                        <option value="no-index">Off</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label for="display_scrip_index">Scripture</label>
                      <select size="1" id="display_scrip_index" name="display_scrip_index">
                        <option value="on-new-page">On, new page</option>
                        <option value="no-page-break">On, inline</option>
                        <option value="no-index">Off</option>
                      </select>
                    </div>
                    <h4>Index Details<select id="index" class="fr">
                      <option value='default'>Default</option>
                      <option value='small'>Small</option>
                      <option value='large'>Large</option>
                      <option value='custom'>Custom</option>
                    </select></h4>
                    <table id="" class="table">
                      <tr>
                        <th><small>Titles</small></th>
                        <th><small>Size</small></th>
                        <th rel="tooltip" title="Spacing below the text"><small>Space</small></th>
                        <th><small>Font</small></th>
                      </tr>
                      <tr>
                        <td>Index</td>
                        <td><input type="number" id="index_title_size" name="index_title_size" value="18"></td>
                        <td><input type="number" id="index_title_space" name="index_title_space" value="6"></td>
                        <td>
                          <select size="1" id="index_title_font" name="index_title_font">
                            <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td rel="tooltip" title="Spacing between songs and the Index if index on same page as songs" colspan=2 class="art"><small>Space Before</small></td>
                        <td><input type="number" id="index_title_b4" name="index_title_b4" value="20"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <td>Category</td>
                        <td><input type="number" id="index_cat_size" name="index_cat_size" value="14"></td>
                        <td><input type="number" id="index_cat_space" name="index_cat_space" value="6"></td>
                        <td>
                          <select size="1" id="index_cat_font" name="index_cat_font">
                            <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td rel="tooltip" title="Spacing before catedories in the category index" colspan=2 class="art"><small>Space Before</small></td>
                        <td><input type="number" id="index_cat_b4" name="index_cat_b4" value="12"></td>
                        <td></td>
                      </tr>
                      <tr>
                        <th colspan=4>
                          <small>Index Song Lines</small>
                        </th>
                      </tr>
                      <tr>
                        <td>Song Title</td>
                        <td><input type="number" id="index_song_size" name="index_song_size" value="12"></td>
                        <td><input type="number" id="index_song_space" name="index_song_space" value="4"></td>
                        <td>
                          <select size="1" id="index_song_font" name="index_song_font">
                            <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td>First Line</td>
                        <td><input type="number" id="index_first_line_size" name="index_first_line_size" value="11"></td>
                        <td><input type="number" id="index_first_line_space" name="index_first_line_space" value="4"></td>
                        <td>
                          <select size="1" id="index_first_line_font" name="index_first_line_font">
                            <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td rel="tooltip" title="Categories to exclude (separate with a ',' no spaces allowed)">Excluded categories</td>
                        <td colspan="3"><input size="30" type="text" id="index_cat_exclude" name="index_cat_exclude"></td>
                      </tr>
                    </table>
                  </div>
                </div>
              </form>
              <button class="btn" id="save_as_default"style="background-color: var(--background-color);" onclick="saveExportDefault();$(this).addClass('bluehighlight'); 
                setTimeout(function(){ $('#save_as_default').removeClass('bluehighlight'); }, 300)">Save as my default</button>
              <button class="btn" id="export_copy" onclick="copyToClipboard(JSON.stringify($('#export_form').serializeArray())); $(this).addClass('bluehighlight'); setTimeout(function(){ $('#export_copy').removeClass('bluehighlight'); }, 300)" style="background-color: var(--background-color); padding: .15rem .55rem .15rem .55rem;font-size: 1.5rem;">‚éò</button>
              <button class="btn" id="export_paste" onclick="navigator.clipboard.readText().then(text => {
                  set_value_by_id(JSON.parse(text)); $('#paper_margin_top').trigger('change');
                }).catch(err => {
                  console.error('Failed to read clipboard contents: ', err);
                }); 
                $(this).addClass('bluehighlight'); 
                setTimeout(function(){ $('#export_paste').removeClass('bluehighlight'); }, 300)" style="background-color: var(--background-color); padding: .5rem .6rem .5rem .6rem;">üìã</button>
            </div>
          </div>
          <div class="subcolumn sidebar" id="exportPreview">
            <div>
              <div>
                <div class="column_header">
                  <h3>Preview
                    <button onclick="$(this).closest('#exportPreview').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button>
                    <button onclick="toggleFullscreen(this)" class="icon-rotate2x icon-fl-right emoji" style="  border-radius: 2rem;">‚Üî</button>
                  </h3>
                </div>
                <iframe id="pdf"></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="column" id="column-filler">
        <div class="float-menu">
        </div>
      </div>
    </main>
    <dialog id="dialog" style="transform: translate3d(calc(50vw - 50%), 0, 0); display: none;">
      <h5 style="margin: 0; color: darkgray;" class="handle">Song</h5>
      <b class="title" style="overflow-wrap: break-word;"></b>
      <div class="content"></div>
      <div class="center_contents">
        <button class="close btn" onclick="$('#dialog').hide(); pauseVideo();">X</button>
      </div>
    </dialog>
    <footer>
    </footer>
    <iframe id="presentation" title="Presentation Slideshow"></iframe>

    <script src="jquery-3.5.1.min.js"></script>
    <script src="pouchdb.min.js"></script>
    <script src="pouchdb.all-dbs.min.js"></script>
    <script src="pouchdb.authentication.min.js"></script>
    <script src="notyf.min.js"></script>

    <script src="db.js"></script>
    <script src="lib.js"></script>
    <script async src="jquery.myTransposer.js"></script>
    <script async src="jquery.toTextarea.js"></script>
    <script src="list.min.js"></script>
    <script src="sortable.js"></script>
    <script async src="jszip.min.js"></script>
    <script async src="import.js"></script>
    <script async src="analytics.js" id="analyticsScript"></script>

    <script>
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if(document.getElementById('autoRadio').checked == true) {
          if (event.matches) {
            document.documentElement.classList.add('dark');
            console.log('üéâ Dark mode is desired');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }
      });

      var sheet = (function() {
        var style = document.createElement("style");
        style.appendChild(document.createTextNode(""));
        document.head.appendChild(style);
        return style.sheet;
      })();
      setTimeout(function(){sheet.insertRule("* { transition: all 0.25s, color 0s, font-size 0s; }", 0); },300);

      dragDialog();

      $('#song .row').append('<button onclick="toggleFullscreen(this)" class="icon-rotate2x tr emoji">&#8596;</button>');

      bindToSongEdit();
      bindSearch('cat', 'c:');
      bindSearch('author', 'a:');
      bindSearch('scrip_ref', 's:');
      bindSearch('key', 'k:');
      
      $("#export_form > label").click(function(e){
        if(this.previousElementSibling.checked){
          e.stopPropagation();
          e.preventDefault();
          this.previousElementSibling.checked = false;
        };
      });
      $('.column').click(function(e){
        var h = this.offsetHeight;
        var w = this.offsetWidth;
        if((h <= 100 && h > 0) || ( w <= 60 && w > 0)) {
          e.preventDefault();
          e.stopPropagation();
          if (confirmWhenEditing()) { return };
          location.hash = $(this).find('.title_link').attr('href');
        }
      });
      $('.content-inner').change(function(){
        export_form_summary_update();
      });
      $('#format').change(function() {
        if(this.value != 'custom'){
          set_value_by_id(JSON.parse(this.value));
          $('#paper_margin_top').trigger('change'); //random element to trigger
        }
      });
      $('#margin').change(function() {
        if(this.value != 'custom'){
          let margins = window.export.margins[this.value];
          document.getElementById('paper_margin_top').value = margins[0];
          document.getElementById('paper_margin_right').value = margins[1];
          document.getElementById('paper_margin_bottom').value = margins[2];
          document.getElementById('paper_margin_left').value = margins[3];
          document.getElementById('column_gutter').value = margins[4];
        }
      });
      $('#text').change(function() {
        if(this.value != 'custom'){
          let text = window.export.text[this.value];
          set_value_by_id(text);
        }
      });
      $('#index').change(function() {
        if(this.value != 'custom'){
          let index = window.export.index[this.value];
          set_value_by_id(index);
        }
      });
      $(function () {
        PouchDB.on('destroyed', function (dbName) {
          console.log('Destroyed: ', dbName);
        });
        PouchDB.on('created', function (dbName) {
          console.log('Created: ', dbName);
        });

        $('input.deletable').wrap('<span class="deleteicon" />').after($('<span/>').on('mouseup touchend',function(e){
          e.preventDefault();
          $(this).prev('input').val('').trigger('change')[0].dispatchEvent(new KeyboardEvent("keyup"));
          if(e.type=='mouseup') {
            $(this).prev('input').focus();
          }else {
            $(this).prev('input').blur();
          }
        }));
        // URL navigation implementing
        window.addEventListener("hashchange", hashchanged, false);
        // Trigger the event (useful on page load).
        hashchanged();
        // keep page from reloading if editing
        window.onbeforeunload = function() {
          return window.editing ? "If you leave this page you will lose your unsaved changes." : null;
        }

        $('#db_select').on('change', function() {
          $('#login').removeClass();
          if($('#db_select :selected').val() == 'create_local') {
            $('#login').addClass('create_local');
          }
          else {
            $('#login').addClass('login_local');
          }
        });
      });   
      function hashchanged(){
        $('.fullscreen').removeClass('fullscreen');
        let pres_iframe = document.getElementById('presentation');
        if(pres_iframe){setTimeout(function(){pres_iframe.remove()},300);}

        var hash = location.hash;
        if(window.old_hash == hash){
          return
        }
        if(confirmWhenEditing()) {
          window.location.hash = window.old_hash;
          return
        }
        if(!(hash.startsWith('#login')) && !window.loggedin){
          location.hash = '#login?'+hash;
          console.log("Hi, let's login first");
          hashchanged();
          return
        }

        logData('hashchanged', hash);

        $('.edit_buttons').remove();
        $('.deleted').removeClass('deleted');
        //if blank - should have to do nothing  
        if(hash == ''){
          $('body').attr('class','header');
          $('.active').removeClass('active');
          window.document.title = "yCanta2";
          updateAllLinks();
        }
//Login
        else if(hash.startsWith('#login')) {
          let userPin = JSON.parse(localStorage.getItem('loggedin'));
          try {
            dbLogin(false, userPin[0], userPin[1], userPin[2]);
            console.log("still logged in!");
          }
          catch {
            console.log("Not logged in yet");
          }

          $('body').attr('class', 'login header');

          PouchDB.allDbs().then(function (all_dbs) {
            let db_opts = '';
            for(item of all_dbs){
              db_opts += '<option value="'+item+'">'+item+'</option>';
            }
            db_opts += '<option value="create_local">Create Local</option>';
            $('#db_select').html(db_opts).trigger('change');
            console.log(db_opts);

          }).catch(function (err) {
            // handle err
          });

          window.document.title = "yCanta2 - Login";
        }
//Songbooks
        else if(hash == '#songbooks'){
          $('body').attr('class','songbookList');
          $('.active').removeClass('active');
          $('#songbookList').addClass('active');
          window.document.title = "yCanta2";
        }
        //if song edit
        else if((hash.search('&s-') != -1) && (hash.search('&edit') != -1)) {
          $('body').attr('class', 'song edit');
          $('.active').removeClass('active');
          $('#song').addClass('active');
          //check if songbook is loaded
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values){
              //Initiate song edit
              editSong();
              updateAllLinks();
              window.document.title = "yCanta2: Editing " + window.song.title;
          });
        }
//if song export
        else if((hash.search('&s-') != -1) && (hash.search('&export') != -1)) {
          //Initiate song export
          $('body').attr('class', 'song export');
          $('.active').removeClass('active');
          $('#export').addClass('active');
          $('#export').removeClass('showStatus');
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(){
              window.exportObject = window.song;
              console.log(exportObject);
              //PREPROCESS THE SONG OBJECT
              // -- REMOVE ALL COMMENTS
              let chunks = [];
              for(var i = 0; i < window.song.content.length; i++) {
                if(window.song.content[i][0].type != 'comment') {
                  chunks.push(window.song.content[i]);
                }
              }
              if(chunks.length == 0) {
                alert("You can't export a song with no verses, chorus, or other text");
                window.location = '#'+window.songbook._id+'&'+window.song._id;
              }
              window.exportObject.content = chunks;

              return 
            }).then(function(values){
              prepExport();
              updateAllLinks();
              window.document.title = "yCanta2: Exporting " + window.song.title;
          });
        }
//if song
        else if(hash.search('&s-') != -1) {
          if(hash.search('s-new-song') != -1){
            window.location.hash = '#' + window.songbook._id;
            return
          }
          $('body').attr('class','song');
          $('.active').removeClass('active');
          $('#song').addClass('active');
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values) {
              updateAllLinks();
              window.document.title = "yCanta2: "+window.songbook.title + " > " + window.song.title;
          });          
        }
//if songbook edit
        else if((hash.search('#sb-') != -1) && (hash.search('&edit') != -1)) {
          //Initiate songbook edit
          $('body').attr('class', 'songList edit');
          $('.active').removeClass('active');
          $('#songList').addClass('active');
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              editSongbook();
              updateAllLinks();
              window.document.title = "yCanta2: Editing " + window.songbook.title;
          });
        }
//if songbook export
        else if((hash.search('#sb-') != -1) && (hash.search('&export') != -1)) {
          //Initiate songbook export
          $('body').attr('class', 'songList export');
          $('.active').removeClass('active');
          $('#export').addClass('active');
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function(){
              //get the songbook object and all songs and save them to window.exportObject
              return new Promise(function(resolve, reject){
                //Songbooks are already loaded into the window.songbook object
                window.exportObject = window.songbook;
                var sb_song_ids = window.songbook.songrefs.map(function (row) {
                    return row.id
                  });
                db.allDocs({
                  include_docs: true,
                  keys: sb_song_ids, //we need error handling for missing ids
                }).then(function (result) {
                  window.exportObject.songs = result.rows;
                  //PREPROCESS THE SONGBOOK OBJECT
                  let procesed_song = [];
                  for(song of window.exportObject.songs) {
                    // -- REMOVE ALL COMMENTS
                    if(song.key != "section"){
                      for(var i = song.doc.content.length - 1; i >= 0; i--) {
                        if(song.doc.content[i][0].type === 'comment') {
                          song.doc.content.splice(i, 1);
                        }
                      }
                    }
                    procesed_song.push(song);        
                  }
                  window.exportObject.songs = procesed_song;

                  prepExport();
                  resolve('Its done');
                }).catch(function (err) {
                  console.log(err);
                });
              });
            }).then(function(values){
              updateAllLinks();
              window.document.title = "yCanta2: Exporting " + window.songbook.title;
          });
        }
//if songbook present
        else if((hash.search('#sb-') != -1) && (hash.search('&present') != -1)) {
          //Initiate songbook export
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function(){
              //get the songbook object and all songs and save them to window.exportObject
              return new Promise(function(resolve, reject){
                //Songbooks are already loaded into the window.songbook object
                window.exportObject = window.songbook;
                var sb_song_ids = window.songbook.songrefs.map(function (row) {
                    return row.id
                  });
                db.allDocs({
                  include_docs: true,
                  keys: sb_song_ids, //we need error handling for missing ids
                }).then(function (result) {
                  //Save json object to data id'd element
                  let myString = JSON.stringify({songs: result.rows.filter(song => song.key != "section"), title: window.songbook.title});
                  let presHtml = '';

                  //load the presentation.html, jquery and presentation.js file into their spots.
                  $.ajax({url: "presentation.html",
                    success: function (data){
                      presHtml = data;
                      $.ajax({url: "jquery-3.5.1.min.js", dataType: 'text',
                        success: function (data){
                          presHtml = presHtml.replace('jQuery_embed', data);
                          $.ajax({url: "presentation.js", dataType: 'text',
                            success: function (data){
                              presHtml = presHtml.replace('presentation_embed', data);
                              if(hash.indexOf('new') > -1){                          //New window/tab
                                window.location = '#'+window.songbook._id;
                                window.presentationFrame = window.open('','_blank', height="200", width="200");
                              }
                              else {                                                 //Iframe
                                var ifrm = document.createElement('iframe');
                                ifrm.id = "presentation";
                                document.body.appendChild(ifrm);
                                ifrm.contentWindow.focus();
                                window.presentationFrame = ifrm.contentWindow || ifrm.contentDocument.document || ifrm. contentDocument;
                              }
                              window.presentationFrame.document.write(presHtml);
                              window.presentationFrame.document.close();
                              window.presentationFrame.document.getElementById('data').setAttribute('data', myString);
                              window.presentationFrame.location = "#";
                              resolve('Its done');
                            }
                          });
                        }
                      });
                    }
                  });
                }).catch(function (err) {
                  console.log(err);
                });
              });
            }).then(function(values){
            if(hash.indexOf('new') == -1){
              $('body').attr('class', 'songList present');
              $('.active').removeClass('active');
              updateAllLinks();
              window.document.title = "yCanta2: Presenting " + window.songbook.title;
            }
          });
        }
//if songbook
        else if(hash.search('#sb-') != -1) {
          $('body').attr('class', 'songList');
          $('.active').removeClass('active');
          $('#songList').addClass('active');
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              updateAllLinks();
              window.document.title = "yCanta2: " + window.songbook.title;
          });
        }
        window.old_hash = window.location.hash;
        $('.column').removeAttr('style');
      }
    </script>
  </body>  
</html>
