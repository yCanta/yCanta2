<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="Description" content="yCanta: Offline-first web application for creating and presenting songs and songbooks">
    <meta name="theme-color" content="lightblue">

    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/x-icon" href="favicon.png">

    <script src="jquery-3.4.0.min.js"></script>
    <script src="pouchdb.min.js"></script>
    <script src="db.js"></script>
    <script src="lib.js"></script>
    <script src="jquery.myTransposer.js"></script>
    <script src="jquery.toTextarea.js"></script>
    <script src="list.min.js"></script>
    <script src="sortable.js"></script>
    <script src="jszip.min.js"></script>
    <script src="song2json.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="jquery.myTransposer.css">
    <link rel="stylesheet" type="text/css" href="2html.css">
    <title>yCanta2: TodosCantas > All Creatures of Our God and King</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body class="songbookList">
    <header>
      <h2><a href="#">yCanta</a></h2>
      <span style="position: absolute; top:0;right:0;">
        <a href="#" style="margin-left: auto; float:right" onclick="db.destroy().then(function () {
            window.location.reload();
          }).catch(function (err) {
            console.log(err);
          });">Delete DB</a><br />
          <label>
            Upload songs:
            <input type="file" id="file" name="file" style="width: 200px" />
          </label>
      </span>
    </header>
    <main>
      <div class="column active" id="songbookList">
        <div class="float-menu">
          <div>
            <a data-songbook-edit="new" class="float-menu-item"><span class="float-menu-icon">+</span> Add SB</a>
            <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
          </div>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div style="width:300px;"  id="songbooks">
              <div id="songbooks_header">
                <a class="title_link" href="#"><h3>Songbooks</h3></a>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbooks" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list"></ul>
            </div>
            <ul style="display:none">
              <li id="songbook-item-template" 
                  data-songbook-id=""
                  data-songbook-rev=""
                  data-songbook-title="">
                <a href="" class="link name" ></a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="column" id="songList">
        <div class="float-menu">
          <a data-song-edit="new" class="float-menu-item"><span class="float-menu-icon">+</span> Add Song</a>
          <button data-home onclick="deleteSongbook(window.songbook_id)" class="float-menu-item delete"><span class="float-menu-icon">&#128465;</span> Delete</button>
          <span class="float-menu-item"><span class="float-menu-icon">&#128253;</span> Present</span>
          <a data-songbook-export class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</a>
          <button data-songbook class="float-menu-item float-menu-editing" onclick="window.editing=false; window.songbook_id=''; window.location.hash=$(this).attr('href');"><span class="float-menu-icon">&#128465;</span> Cancel</button>
          <button data-songbook class="float-menu-item float-menu-editing" onclick="if($('#songbook_title').text().trim() == ''){alert('Please add a title before you save');}else{window.editing=false; saveSongbook(parseHash('sb-'));}"><span class="float-menu-icon">&#128190;</span> Save</button>
          <a data-songbook-edit class="float-menu-item"><span class="float-menu-icon">&#9998;</span> Edit</a>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div style="width:400px;" id="songbook_content">
              <div id="songbook_header">
                <a data-songbook class="title_link" href="#"><h3 id="songbook_title">todosCantas</h3></a>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbook_content" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list"></ul>
            </div>
            <ul style="display:none">
              <li id="song-item-template" 
                  data-song-id=""
                  data-song-rev=""
                  data-song-title=""
                  data-song-authors=""
                  data-song-scripture_ref=""
                  data-song-introduction=""
                  data-song-key=""
                  data-song-categories=""
                  data-song-cclis=""
                  data-song-content=""
                  data-song-copyright="">
                  <a href="" class="link name" ></a>
              </li>
            </ul>
          </div>
          <div class="subcolumn sidebar" id="songListEdit">
            <div id="songbook_edit_togglesongs" style="width: 240px">
              <div class="sticky">
                <h3>Add a song?<button onclick="$(this).closest('.sidebar-open').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbook_edit_togglesongs" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list">
              </ul>
              <ul style="display:none">
                <li id="song-item-template-edit" 
                  data-song-id=""
                  data-song-rev=""
                  data-song-title=""
                  data-song-authors=""
                  data-song-scripture=""
                  data-song-introduction=""
                  data-song-key=""
                  data-song-categories=""
                  data-song-cclis=""
                  data-song-content=""
                  data-song-copyright="">
                  <a href="" class="name" ></a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="column nochords" id="song">
        <div class="float-menu">
          <button data-songbook onclick="deleteSong(window.song_id)" class="float-menu-item"><span class="float-menu-icon">&#128465;</span> Delete</button>
          <button class="float-menu-item toggle-chords"><span class="float-menu-icon">&#9839;</span> Chords</button>
          <a data-song-export class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</a>
          <span class="float-menu-item"><span class="float-menu-icon">&#128253;</span> Present</span>
          <button data-song class="float-menu-item float-menu-editing" onclick="window.editing=false; window.location.hash=$(this).attr('href');"><span class="float-menu-icon">&#128465;</span> Cancel</button>
          <button data-song class="float-menu-item float-menu-editing" onclick="if($('stitle').text().trim() == ''){alert('Please add a title before you save');}else{window.editing=false; prepSaveSong($(this));}"><span class="float-menu-icon">&#128190;</span> Save</button>
          <a data-song-edit class="float-menu-item"><span class="float-menu-icon">&#9998;</span> Edit</a>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div class="content" style="width: 400px;">
            </div>
          </div>
          <div class="subcolumn sidebar" id="song-edit">
            <div id="categories" style="width: 240px;">
              <div class="sticky">
                <h3>Song Categories<button onclick="$(this).closest('#song-edit').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#categories" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list">
              </ul>
              <ul style="display:none">
                <li id="category-template">
                  <label>
                    <input type="checkbox">
                    <span class="name"></span>
                  </label>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="column" id="export">
        <div class="float-menu">
          <button class="float-menu-item" onclick="window.location.hash=window.location.hash.replace('&export','');"><span class="float-menu-icon">&#128465;</span> Cancel</button>
          <button data-song class="float-menu-item"><span class="float-menu-icon">&#128190;</span> Save</button>
          <span class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</span>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div class="content" style="min-width: 300px; max-width: 425px">
              <h3>Export</h3>

              <input id="collapsible1" class="toggle" type="radio" name="accordion">
              <label for="collapsible1" class="lbl-toggle">Page Options</label>
              <div class="collapsible-content">
                <div class="content-inner">
                  <table>
                    <tr>
                      <td style="width:40%">
                        <label>Chords</label>
                        <select size="1" id="display_chords" name="display_chords">
                          <option value="no">no</option>
                          <option value="yes">yes</option>
                          <option value="yes">1st</option>
                        </select>
                      </td>
                      <td class="hide_for_songs">
                        <input type="checkbox" id="start_song_on_new_page" name="start_song_on_new_page">
                        <label>Start songs on new pages:</label>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <label>Columns</label>
                        <input type="number" id="columns" name="columns">
                      </td>
                      <td> 
                        <label>CCLI license#</label>
                        <input size="7" type="text" id="ccli" name="ccli">
                      </td>
                    </tr>
                  </table>
                  <h4>Page Setup</h4>
                  <div class="t3" title="Choose the songs you want to print based on status">
                    <label>Print</label>
                    <span>
                      <input type="checkbox" id="print_a" name="print_a">
                      <label for="print_a"><img src="static/images/thumb_up_green.png"></label>
                      <input type="checkbox" id="print_n" name="print_n">
                      <label for="print_n"><img src="static/images/time_yellow.png"></label>
                      <input type="checkbox" id="print_r" name="print_r">
                      <label for="print_r"><img src="static/images/thumb_down_red.png"></label>
                    </span>
                  </div>
                  <div class="t3" title="Choose the physical layout of the songbook">
                    <label>Layout</label>
                    <select size="1" id="page_layout" name="page_layout">
                      <option value="single-sided">single-sided</option><option value="booklet">booklet</option><option value="double-sided">double-sided</option><option value="adobe-booklet">adobe-booklet</option>
                    </select>
                  </div>
                  <div class="t3">
                    <label>Orientation</label>
                    <select size="1" id="paper_orientation" name="paper_orientation">
                      <option value="portrait">portrait</option><option value="landscape">landscape</option>
                    </select>
                  </div>
                  <div class="t3">
                    <label>Paper Size</label>
                    <select size="1" id="paper_size" name="paper_size" style="display: inline-block;">
                      <option value="A0">A0</option><option value="A1">A1</option><option value="A2">A2</option><option value="A3">A3</option><option value="A4">A4</option><option value="A5">A5</option><option value="A6">A6</option><option value="B0">B0</option><option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option><option value="B4">B4</option><option value="B5">B5</option><option value="B6">B6</option><option value="11x17">11x17</option><option value="LEGAL">LEGAL</option><option value="LETTER">LETTER</option>
                    </select>
                  </div>
                  <div class="t3" title="Font to be used in the songbook">
                    <label>Font</label>
                    <select size="1" id="font_face" name="font_face" style="display: inline-block;">
                      <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                    </select>
                  </div>
                  <h4>Margins</h4>
                  <table class="table">
                    <tr>
                      <th>
                      </th>
                      <th>
                        <small>Size</small>
                      </th>
                      <th>
                      </th>
                      <th>
                        <small>Size</small>
                      </th>
                    <tr>
                      <td>
                        Top
                      </td>
                      <td>
                        <input type="number" id="margin_top" name="margin_top">
                      </td>
                      <td>
                        Bottom
                      </td>
                      <td>
                        <input type="number" id="margin_bottom" name="margin_bottom">
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <span data-booklet="Inside">Left</span>
                      </td>
                      <td>
                        <input type="number" id="margin_left" name="margin_left">
                      </td>
                      <td>
                        <span data-booklet="Outside">Right</span>
                      </td>
                      <td>
                        <input type="number" id="margin_right" name="margin_right">
                      </td>
                    </tr>
                    <tr>
                      <td>
                        Gutter
                      </td>
                      <td>
                        <input type="number" id="margin_gutter" name="margin_gutter">
                      </td>
                      <td>
                        Column Gutter
                      </td>
                      <td>
                        <input type="number" id="column_gutter" name="column_gutter">
                        <select size="1" id="resize_percent" name="resize_percent">
                          <option value="left">Left</option>
                          <option value="top">Top</option>
                          <option value="inside">Inside</option>
                        </select>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>

              <input id="collapsible2" class="toggle" type="radio" name="accordion">
              <label for="collapsible2" class="lbl-toggle">Text Options</label>
              <div class="collapsible-content">
                <div class="content-inner">
                  <table class="table">
                    <tr>
                      <th></th>
                      <th><small>Size</small></th>
                      <th title="Space below the text"><small>Space</small></th>
                      <th title="Allow automatic reduction of font size to this percentage of the set font size"><small>Resize</small></th>
                    </tr>
                    <tr class="hide_for_songs">
                      <td>Book Title</td>
                      <td><input type="number" id="booktitle_size" name="booktitle_size"></td>
                      <td><input type="number" id="booktitle_space" name="booktitle_space"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td>Song Title</td>
                      <td><input type="number" id="songtitle_size" name="songtitle_size"></td>
                      <td><input type="number" id="songtitle_space" name="songtitle_space"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td><small>Small Text</small></td>
                      <td><input type="number" id="small_size" name="small_size"></td>
                      <td><input type="number" id="small_space" name="small_space"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td>Line</td>
                      <td><input type="number" id="songline_size" name="songline_size"></td>
                      <td><input type="number" id="songline_space" name="songline_space"></td>
                      <td title="Allow automatic reduction of font size to this percentage of the set font size">
                        <select size="1" id="resize_percent" name="resize_percent">
                          <option value="100">100%</option><option value="95">95%</option><option value="90">90%</option><option value="85">85%</option><option value="80">80%</option><option value="75">75%</option><option value="70">70%</option><option value="65">65%</option><option value="60">60%</option><option value="55">55%</option><option value="50">50%</option>
                          <option value="0">Wrap</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>Chord</td>
                      <td><input type="number" id="songchord_size" name="songchord_size"></td>
                      <td><input type="number" id="songchord_space" name="songchord_space"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td colspan=2 title="Spacing before Chorus/Verse/Bridge/etc">Block Spacing</td>
                      <td><input type="number" id="songchunk_b4" name="songchunk_b4"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td colspan=2 title="Spacing after the end of the song">Song Spacing</td>
                      <td><input type="number" id="song_space_after" name="song_space_after"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td>Copyright</td>
                      <td><input type="number" id="copyright_size" name="copyright_size"></td>
                      <td><input type="number" id="copyright_space_b4" name="copyright_space_b4"></td>
                      <td></td>
                    </tr>
                  </table>
                  <h4>Other Options</h4>
                  <dl>
                    <span class="hide_for_songs">
                      <dt>Hide book title?</dt>
                      <dd>
                        <select size="1" id="hide_booktitle" name="hide_booktitle">
                          <option value="no">no</option><option value="yes">yes</option>
                        </select>
                      </dd>
                      <dt title="($num substitutes the song number; \s must be used for spaces)">Song number format:</dt>
                      <dd>
                        <input size="10" type="text" id="songtitle_format" value="$num\s" name="songtitle_format">
                      </dd>
                    </span>
                    <dt>Scripture reference location</dt>
                    <dd>
                      <select size="1" id="scripture_location" name="scripture_location" style="display: inline-block;">
                        <option value="in-title">in-title</option><option value="under-title">under-title</option>
                      </select>
                    </dd>
                  </dl>
                </div>
              </div>

              <input id="collapsible3" class="toggle" type="radio" name="accordion">
              <label for="collapsible3" class="lbl-toggle">Index Options</label>
              <div class="collapsible-content">
                <div class="content-inner">
                  <div class="hide_for_songs">
                    <b>Include Indexes?</b><br><br>
                    <div class="t3">
                      <label>Categories</label>
                      <select size="1" id="display_cat_index" name="display_cat_index">
                        <option value="on-new-page">on-new-page</option><option value="no-page-break">no-page-break</option><option value="no-index">no-index</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label>Scripture</label>
                      <select size="1" id="display_scrip_index" name="display_scrip_index">
                        <option value="on-new-page">on-new-page</option><option value="no-page-break">no-page-break</option><option value="no-index">no-index</option>
                      </select>
                    </div>
                    <div class="t3">
                      <label>Alphabetical</label>
                      <select size="1" id="display_index" name="display_index">
                        <option value="on-new-page">on-new-page</option><option value="no-page-break">no-page-break</option><option value="no-index">no-index</option>
                      </select><br>
                    </div>
                    <span style="float: right;">
                      <input type="checkbox" id="include_first_line" name="include_first_line"><label for="include_first_line">Include 1st verse and chorus?</label>
                    </span>
                  </div>
                  <br><br>
                  <table class="table">
                    <tr>
                      <th><small>Titles</small></th>
                      <th><small>Size</small></th>
                      <th title="Spacing below the text"><small>Space</small></th>
                      <th><small>Font</small></th>
                    </tr>
                    <tr>
                      <td>Index</td>
                      <td><input type="number" id="index_title_size" name="index_title_size"></td>
                      <td><input type="number" id="index_title_space" name="index_title_space"></td>
                      <td>
                        <select size="1" id="index_title_font" name="index_title_font">
                          <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td title="Spacing between songs and the Index if index on same page as songs" colspan=2 class="art"><small>Space Before</small></td>
                      <td><input type="number" id="index_title_b4" name="index_title_b4"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td>Category</td>
                      <td><input type="number" id="index_cat_size" name="index_cat_size"></td>
                      <td><input type="number" id="index_cat_space" name="index_cat_space"></td>
                      <td>
                        <select size="1" id="index_cat_font" name="index_cat_font">
                          <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td title="Spacing before catedories in the category index" colspan=2 class="art"><small>Space Before</small></td>
                      <td><input type="number" id="index_cat_b4" name="index_cat_b4"></td>
                      <td></td>
                    </tr>
                    <tr>
                      <th colspan=4>
                        <small>Index Song Lines</small>
                      </th>
                    </tr>
                    <tr>
                      <td>Song Title</td>
                      <td><input type="number" id="index_song_size" name="index_song_size"></td>
                      <td><input type="number" id="index_song_space" name="index_song_space"></td>
                      <td>
                        <select size="1" id="index_song_font" name="index_song_font">
                          <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>First Line</td>
                      <td><input type="number" id="index_first_line_size" name="index_first_line_size"></td>
                      <td><input type="number" id="index_first_line_space" name="index_first_line_space"></td>
                      <td>
                        <select size="1" id="index_first_line_font" name="index_first_line_font">
                          <option value="Courier">Courier</option><option value="Courier-Bold">Courier-Bold</option><option value="Courier-BoldOblique">Courier-BoldOblique</option><option value="Courier-Oblique">Courier-Oblique</option><option value="Helvetica">Helvetica</option><option value="Helvetica-Bold">Helvetica-Bold</option><option value="Helvetica-BoldOblique">Helvetica-BoldOblique</option><option value="Helvetica-Oblique">Helvetica-Oblique</option><option value="Symbol">Symbol</option><option value="Times-Bold">Times-Bold</option><option value="Times-BoldItalic">Times-BoldItalic</option><option value="Times-Italic">Times-Italic</option><option value="Times-Roman">Times-Roman</option><option value="ZapfDingbats">ZapfDingbats</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td title="Categories to exclude (separate with a ',' no spaces allowed)">Excluded categories</td>
                      <td colspan="3"><input size="30" type="text" id="index_cat_exclude" name="index_cat_exclude"></td>
                    </tr>
                  </table>
                </div>
              </div>

              <input id="collapsible4" class="toggle" type="radio" name="accordion">
              <label for="collapsible4" class="lbl-toggle">More Info</label>
              <div class="collapsible-content">
                <div class="content-inner">
                  <p>
                    Settings:!
                  </p>
                </div>
              </div>
              
            </div>
          </div>
          <div class="subcolumn sidebar" id="exportPreview">
            <div style="width: 240px;">
              <div class="sticky">
                <h3>Preview<button onclick="$(this).closest('#exportPreview').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="column" id="column-filler">
        <div class="float-menu">
        </div>
        <div id="result">
        </div>
      </div>
      
    </main>
    <footer>
      <span style="float: right;">rev __________ 1</span>    
      <div id="debugDiv">
      </div>
    </footer>
    <script>
      $('#song .row').append('<button onclick="toggleFullscreen(this)" class="icon-rotate2x tr">&#8596;</button>');

      bindToSongEdit();
      initializeSongbooksList();
      $('.column').click(function(e){
        var h = this.offsetHeight;
        var w = this.offsetWidth;
        if((h <= 200 && h > 0) || ( w <= 200 && w > 0)) {
          e.preventDefault();
          e.stopPropagation();
          if (confirmWhenEditing()) { return };
          location.hash = $(this).find('.title_link').attr('href');
        }
      });
      $(function () {
        $('input.deletable').wrap('<span class="deleteicon" />').after($('<span/>').click(function() {
          $(this).prev('input').val('').trigger('change').focus()[0].dispatchEvent(new KeyboardEvent("keyup"));
        }));
        // URL navigation implementing
        window.addEventListener("hashchange", hashchanged, false);
        // Trigger the event (useful on page load).
        hashchanged();
        // keep page from reloading if editing
        window.onbeforeunload = function() {
          return window.editing ? "If you leave this page you will lose your unsaved changes." : null;
        }
        // keep hash from changing if editing
        $('body').on('click', 'a[href]', function(e) {
          e.preventDefault();
          var $item = $(e.currentTarget), hashValue = $item.attr('href').slice(1);
          // Check to see if we're editing
          if (confirmWhenEditing()) { return };
          
          //set the hash if necessary still
          window.location.hash = hashValue;
          return false;
        });
      });   
      function hashchanged(){
        var hash = location.hash;
        /*/doesn't yet prevent - but does let you know need to restore the hash.
        if(window.editing){
          confirmWhenEditing();
        }*/
        //if blank - should have to do nothing
        if(hash == ''){
         $('body').attr('class','songbookList');
         $('.active').removeClass('active');
         $('#songbookList').addClass('active');
         updateAllLinks();
        }
        //if song edit
        else if((hash.search('&s-') != -1) && (hash.search('&edit') != -1)) {
          //check if songbook is loaded
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values){
              //Initiate song edit
              $('body').attr('class', 'song edit');
              $('.active').removeClass('active');
              $('#song').addClass('active');
              editSong();
              updateAllLinks();
          });
        }
        //if song export
        else if((hash.search('&s-') != -1) && (hash.search('&export') != -1)) {
          //Initiate song export
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values){
              //Initiate song edit
              $('body').attr('class', 'song export');
              $('.active').removeClass('active');
              $('#export').addClass('active');
              updateAllLinks();
          });
        }
        //if song
        else if(hash.search('&s-') != -1) {
          if(hash.search('s-new-song') != -1){
            window.location.hash = '#'+window.songbook_id;
            return
          }
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values) {
              $('body').attr('class','song');
              $('.active').removeClass('active');
              $('#song').addClass('active');  
              updateAllLinks();
          });          
        }
        //if songbook edit
        else if((hash.search('#sb-') != -1) && (hash.search('&edit') != -1)) {
          //Initiate songbook edit
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              $('body').attr('class', 'songList edit');
              $('.active').removeClass('active');
              $('#songList').addClass('active');
              editSongbook();
              updateAllLinks();
          });
        }
        //if songbook export
        else if((hash.search('#sb-') != -1) && (hash.search('&export') != -1)) {
          //Initiate songbook export
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              $('body').attr('class', 'songList export');
              $('.active').removeClass('active');
              $('#export').addClass('active');
              updateAllLinks();
          });
        }
        //if songbook
        else if(hash.search('#sb-') != -1) {
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              $('body').attr('class', 'songList');
              $('.active').removeClass('active');
              $('#songList').addClass('active');
              updateAllLinks();
          });
        }
      }
    </script>
  </body>
</html>
