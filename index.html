<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="Description" content="yCanta: Offline-first web application for creating and presenting songs and songbooks">
    <meta name="theme-color" content="lightblue">

    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/x-icon" href="favicon.png">

    <script src="jquery-3.4.0.min.js"></script>
    <script src="pouchdb.min.js"></script>
    <script src="db.js"></script>
    <script src="lib.js"></script>
    <script src="jquery.myTransposer.js"></script>
    <script src="jquery.toTextarea.js"></script>
    <script src="list.min.js"></script>
    <script src="sortable.js"></script>
    <script src="jszip.min.js"></script>
    <script src="song2json.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="jquery.myTransposer.css">
    <link rel="stylesheet" type="text/css" href="2html.css">
    <title>yCanta2: TodosCantas > All Creatures of Our God and King</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body class="songbookList">
    <header>
      <h2><a href="#">yCanta</a></h2>
      <span style="position: absolute; top:0;right:0;">
        <a href="#" style="margin-left: auto; float:right" onclick="db.destroy().then(function () {
            window.location.reload();
          }).catch(function (err) {
            console.log(err);
          });">Delete DB</a><br />
          <label>
            Upload songs:
            <input type="file" id="file" name="file" style="width: 200px" />
          </label>
      </span>
    </header>
    <main>
      <div class="column active" id="songbookList">
        <div class="float-menu">
          <div>
            <a data-songbook-edit="new" class="float-menu-item"><span class="float-menu-icon">+</span> Add SB</a>
            <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
          </div>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div style="width:300px;"  id="songbooks">
              <div id="songbooks_header">
                <a class="title_link" href="#"><h3>Songbooks</h3></a>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbooks" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list"></ul>
            </div>
            <ul style="display:none">
              <li id="songbook-item-template" 
                  data-songbook-id=""
                  data-songbook-rev=""
                  data-songbook-title="">
                <a href="" class="link name" ></a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="column" id="songList">
        <div class="float-menu">
          <a data-song-edit="new" class="float-menu-item"><span class="float-menu-icon">+</span> Add Song</a>
          <button data-home onclick="deleteSongbook(window.songbook_id)" class="float-menu-item delete"><span class="float-menu-icon">&#128465;</span> Delete</button>
          <span class="float-menu-item"><span class="float-menu-icon">&#128253;</span> Present</span>
          <span class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</span>
          <button data-songbook class="float-menu-item float-menu-editing" onclick="window.editing=false; window.location.hash=$(this).attr('href');"><span class="float-menu-icon">&#128465;</span> Cancel</button>
          <button data-songbook class="float-menu-item float-menu-editing" onclick="window.editing=false; saveSongbook(parseHash('sb-'));"><span class="float-menu-icon">&#128190;</span> Save</button>
          <a data-songbook-edit class="float-menu-item"><span class="float-menu-icon">&#9998;</span> Edit</a>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div style="width:400px;" id="songbook_content">
              <div id="songbook_header">
                <a data-songbook class="title_link" href="#"><h3 id="songbook_title">todosCantas</h3></a>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbook_content" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list"></ul>
            </div>
            <ul style="display:none">
              <li id="song-item-template" 
                  data-song-id=""
                  data-song-rev=""
                  data-song-title=""
                  data-song-authors=""
                  data-song-scripture_ref=""
                  data-song-introduction=""
                  data-song-key=""
                  data-song-categories=""
                  data-song-cclis=""
                  data-song-content=""
                  data-song-copyright="">
                  <a href="" class="link name" ></a>
              </li>
            </ul>
          </div>
          <div class="subcolumn sidebar" id="songListEdit">
            <div id="songbook_edit_togglesongs" style="width: 240px">
              <div class="sticky">
                <h3>Add a song?<button onclick="$(this).closest('.sidebar-open').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#songbook_edit_togglesongs" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list">
              </ul>
              <ul style="display:none">
                <li id="song-item-template-edit" 
                  data-song-id=""
                  data-song-rev=""
                  data-song-title=""
                  data-song-authors=""
                  data-song-scripture=""
                  data-song-introduction=""
                  data-song-key=""
                  data-song-categories=""
                  data-song-cclis=""
                  data-song-content=""
                  data-song-copyright="">
                  <a href="" class="name" ></a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="column nochords" id="song">
        <div class="float-menu">
          <button data-songbook onclick="deleteSong(window.song_id)" class="float-menu-item"><span class="float-menu-icon">&#128465;</span> Delete</button>
          <button class="float-menu-item toggle-chords"><span class="float-menu-icon">&#9839;</span> Chords</button>
          <span class="float-menu-item"><span class="float-menu-icon">&#128424;</span> Export</span>
          <span class="float-menu-item"><span class="float-menu-icon">&#128253;</span> Present</span>
          <button data-song class="float-menu-item float-menu-editing" onclick="window.editing=false; window.location.hash=$(this).attr('href');"><span class="float-menu-icon">&#128465;</span> Cancel</button>
          <button data-song class="float-menu-item float-menu-editing" onclick="window.editing=false; prepSaveSong($(this));"><span class="float-menu-icon">&#128190;</span> Save</button>
          <a data-song-edit class="float-menu-item"><span class="float-menu-icon">&#9998;</span> Edit</a>
          <span class="float-menu-item  float-menu-toggle"><button type="button" class="float-menu-icon">+</button></span>
        </div>
        <div class="row">
          <div class="subcolumn">
            <div class="content" style="width: 400px;">
            </div>
          </div>
          <div class="subcolumn sidebar" id="song-edit">
            <div id="categories" style="width: 240px;">
              <div class="sticky">
                <h3>Song Categories<button onclick="$(this).closest('#song-edit').removeClass('sidebar-open');" class="icon-fl-right close-icon">&times;</button></h3>
                <input aria-label="Search" class="search deletable" type="text" data-target="#categories" data-trigger="change" placeholder="Search">
              </div>
              <ul class="list">
              </ul>
              <ul style="display:none">
                <li id="category-template">
                  <label>
                    <input type="checkbox">
                    <span class="name"></span>
                  </label>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="column" id="column-filler">
        <div class="float-menu">
        </div>
        <div id="result">
        </div>
      </div>
      
    </main>
    <footer>
      <span style="float: right;">rev __________ 1</span>    
      <div id="debugDiv">
      </div>
    </footer>
    <script>
      $('#song .row').append('<button onclick="toggleFullscreen(this)" class="icon-rotate2x tr">&#8596;</button>');

      bindToSongEdit();
      initializeSongbooksList();
      $('.column').click(function(e){
        var h = $(this).height();
        var w = $(this).width();
        if((h <= 200 && h > 0) || ( w <= 200 && w > 0)) {
          e.preventDefault();
          e.stopPropagation();
          if (confirmWhenEditing()) { return };
          location.hash = $(this).find('.title_link').attr('href');
        }
      });
      $(function () {
        $('input.deletable').wrap('<span class="deleteicon" />').after($('<span/>').click(function() {
          $(this).prev('input').val('').trigger('change').focus();
        }));
        // URL navigation implementing
        window.addEventListener("hashchange", hashchanged, false);
        // Trigger the event (useful on page load).
        hashchanged();
        // keep page from reloading if editing
        window.onbeforeunload = function() {
          return window.editing ? "If you leave this page you will lose your unsaved changes." : null;
        }
        // keep hash from changing if editing
        $('body').on('click', 'a[href]', function(e) {
          e.preventDefault();
          var $item = $(e.currentTarget), hashValue = $item.attr('href').slice(1);
          // Check to see if we're editing
          if (confirmWhenEditing()) { return };
          
          //set the hash if necessary still
          window.location.hash = hashValue;
          return false;
        });
      });   
      function hashchanged(){
        var hash = location.hash;
        /*/doesn't yet prevent - but does let you know need to restore the hash.
        if(window.editing){
          confirmWhenEditing();
        }*/
        //if blank - should have to do nothing
        if(hash == ''){
         $('body').attr('class','songbookList');
         $('.active').removeClass('active');
         $('#songbookList').addClass('active');
         updateAllLinks();
        }
        //if song edit
        else if((hash.search('&s-') != -1) && (hash.search('&edit') != -1)) {
          //check if songbook is loaded
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values){
              console.log(values);
              //Initiate song edit
              $('body').attr('class', 'song edit');
              $('.active').removeClass('active');
              $('#song').addClass('active');
              editSong();
              updateAllLinks();
          });
        }
        //if song
        else if(hash.search('&s-') != -1) {
          if(hash.search('s-new-song') != -1){
            window.location.hash = '#'+window.songbook_id;
            return
          }
          //Need to check check if songbook is loaded
          Promise.all([loadSongbook(parseHash('sb-')), loadSong(parseHash('s-'))])
            .then(function(values) {
              $('body').attr('class','song');
              $('.active').removeClass('active');
              $('#song').addClass('active');  
              updateAllLinks();
          });          
        }
        //if songbook edit
        else if((hash.search('#sb-') != -1) && (hash.search('&edit') != -1)) {
          //Initiate songbook edit
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              $('body').attr('class', 'songList edit');
              $('.active').removeClass('active');
              $('#songList').addClass('active');
              editSongbook();
              updateAllLinks();
          });
        }
        //if songbook
        else if(hash.search('#sb-') != -1) {
          Promise.resolve(loadSongbook(parseHash('sb-')))
            .then(function() {
              $('.active').removeClass('active');
              $('#songList').addClass('active');
              updateAllLinks();
          });
        }
      }
    </script>
  </body>
</html>
